## 📋 Web3 课程平台 - 详细任务清单 (更新版)

### 🟢 已完成任务

#### 智能合约开发

- ✅ **YDToken.sol** - ERC20 代币合约

  - mint() 铸造函数
  - transfer() 转账功能
  - approve() 授权机制
  - 总供应量：100 万 YD 代币
  - 已部署到 Sepolia: `0x752250B9471b77e85c3DE330db8a5d7802Eb87d7`

- ✅ **CourseManager.sol** - 课程管理合约

  - createCourse() 创建课程
  - purchaseCourse() 购买课程
  - updateUser() 更新用户信息
  - hasPurchased() 购买状态查询
  - getCoursesPaginated() 分页查询
  - 已部署到 Sepolia: `0xCb4A483c8F1F84BF0128a7081c0d4FC4A2607EE7`

- ✅ **SimpleStaking.sol** - 质押合约
  - stake() 质押 YD 代币
  - unstake() 取消质押+领取收益
  - calculateReward() 计算收益
  - 每日 1%收益率
  - 已部署到 Sepolia: `0xf5924164C4685f650948bf4a51124f0CB24DA026`

#### 合约验证与部署

- ✅ **Hardhat 项目搭建** - TypeScript + Ignition 配置
- ✅ **合约部署到 Sepolia** - 使用 Ignition 模块化部署
- ✅ **Etherscan 合约验证** - 源码已验证，可在 Etherscan 查看和交互

#### 前端基础架构

- ✅ **前端项目搭建** - Vite + React + TypeScript
- ✅ **依赖安装** - ethers v6, tailwindcss, zustand, react-router-dom
- ✅ **Tailwind CSS 配置** - 样式框架配置完成
- ✅ **项目结构创建** - hooks/, services/, store/, components/, pages/

- ✅ **核心 Hook 开发**
  - `useWallet.ts` - MetaMask 连接管理 (ethers v6)
  - `useContracts.ts` - 智能合约交互封装
- ✅ **服务层开发**
  - `api.ts` - Fetch 封装的 HTTP 请求服务
  - `useStore.ts` - Zustand 状态管理

### 🔴 待完成任务

#### 前端组件开发

##### 🏗️ **通用组件** (`src/components/`)

- ❌ **WalletButton.tsx** - 钱包连接按钮

  ```typescript
  // 功能点：
  -显示连接状态 - 连接 / 断开钱包 - 网络切换提示 - 地址显示;
  ```

- ❌ **LoadingSpinner.tsx** - 加载动画组件
- ❌ **Modal.tsx** - 通用模态框组件
- ❌ **CourseCard.tsx** - 课程卡片组件
- ❌ **Layout.tsx** - 页面布局组件

##### 📄 **页面组件开发** (`src/pages/`)

###### 🏠 **首页** (`Home.tsx`)

- ❌ **项目介绍展示**
- ❌ **钱包连接入口**
- ❌ **导航到各功能页面**

###### 🛒 **课程页面** (`Courses.tsx`)

- ❌ **课程列表展示**

  ```typescript
  // 实现功能：
  - 从合约读取课程总数
  - 分页显示课程列表
  - 课程卡片(标题、描述、价格、讲师)
  - 搜索/筛选功能(可选)
  ```

- ❌ **创建课程模态框**

  ```typescript
  // CreateCourseModal.tsx
  const createCourse = async (title, description, price) => {
    // 1. 调用合约创建课程
    const { courseId, txHash } = await courseOperations.createCourse(
      title,
      description,
      price
    );

    // 2. 存储到后端数据库
    await courseApi.createCourse({
      courseId: courseId.toString(),
      title,
      description,
      price,
      instructorAddress: account,
      txHash,
    });
  };
  ```

- ❌ **购买课程流程**
  ```typescript
  const purchaseCourse = async (courseId: number, price: string) => {
    // 1. 检查YD余额
    const balance = await tokenOperations.getBalance(account);
    if (parseFloat(balance) < parseFloat(price)) {
      alert("YD代币余额不足");
      return;
    }

    // 2. 授权操作
    await tokenOperations.approve(CONTRACT_ADDRESSES.CourseManager, price);

    // 3. 购买课程
    const txHash = await courseOperations.purchaseCourse(courseId);

    // 4. 记录到数据库
    await purchaseApi.recordPurchase({
      userAddress: account,
      courseId: courseId.toString(),
      txHash,
      pricePaid: price,
    });

    alert("购买成功！");
  };
  ```

###### 📚 **课程详情页** (`CourseDetail.tsx`)

- ❌ **课程信息展示**

  ```typescript
  // URL: /courses/:courseId
  // 功能点：
  - 课程标题、描述、价格
  - 讲师信息显示
  - 购买状态检查
  ```

- ❌ **访问权限验证(签名)**
  ```typescript
  const getCourseDetails = async (courseId: string) => {
    const timestamp = Date.now();
    const message = `Access course ${courseId} at ${timestamp}`;
    const signature = await signer.signMessage(message);

    const response = await courseApi.getCourseDetails(
      courseId,
      account,
      signature,
      timestamp
    );

    if (response.success && response.data.hasPurchased) {
      // 显示课程内容
      setCanAccess(true);
    } else {
      // 显示购买按钮
      setCanAccess(false);
    }
  };
  ```

###### 👤 **个人中心页** (`Profile.tsx`)

- ❌ **用户资料展示与编辑**

  ```typescript
  // 功能点：
  -钱包地址显示(格式化显示) -
    昵称输入框 -
    个人简介输入框 -
    YD代币余额显示 -
    更新按钮;
  ```

- ❌ **资料更新(签名验证)**

  ```typescript
  const updateProfile = async (nickname: string, bio: string) => {
    const timestamp = Date.now();
    const message = `Update profile: ${nickname} - ${bio} at ${timestamp}`;

    // MetaMask签名
    const signature = await signer.signMessage(message);

    // 提交到后端
    const response = await userApi.updateProfile(
      account,
      nickname,
      bio,
      signature,
      timestamp
    );

    if (response.success) {
      alert("更新成功！");
      // 更新本地状态
    }
  };
  ```

- ❌ **已购买课程列表**
  ```typescript
  // 功能点：
  - 显示用户购买的所有课程
  - 购买时间、价格信息
  - 点击进入课程详情
  - 学习进度显示(可选)
  ```

###### 💰 **质押页面** (`Staking.tsx`)

- ❌ **质押信息仪表板**

  ```typescript
  // 功能点：
  -当前质押金额显示 -
    质押时间显示 -
    实时收益计算 -
    总质押池信息 -
    APY显示(1 % 每日);
  ```

- ❌ **质押操作区域**

  ```typescript
  const stakeTokens = async (amount: string) => {
    // 1. 检查余额
    const balance = await tokenOperations.getBalance(account);
    if (parseFloat(balance) < parseFloat(amount)) {
      alert("余额不足");
      return;
    }

    // 2. 授权质押合约
    await tokenOperations.approve(CONTRACT_ADDRESSES.SimpleStaking, amount);

    // 3. 执行质押
    const txHash = await stakingOperations.stake(amount);

    alert("质押成功！");
    // 刷新质押信息
    loadStakeInfo();
  };
  ```

- ❌ **取消质押功能**
  ```typescript
  const unstakeTokens = async () => {
    const txHash = await stakingOperations.unstake();
    alert("取消质押成功！获得本金+收益");
    loadStakeInfo();
  };
  ```

##### 🌐 **路由配置** (`src/App.tsx`)

- ❌ **React Router 配置**
  ```typescript
  // 路由结构：
  / - 首页
  /courses - 课程列表
  /courses/:id - 课程详情
  /profile - 个人中心
  /staking - 质押页面
  ```

#### 后端开发 (Node.js + Express + MySQL)

##### 🏗️ **后端项目搭建**

- ❌ **项目初始化**

  ```bash
  mkdir backend && cd backend
  npm init -y
  npm install express mysql2 ethers@^6.0.0 cors dotenv
  npm install -D nodemon typescript @types/node @types/express
  ```

- ❌ **TypeScript 配置**
- ❌ **数据库连接配置**

##### 🗄️ **数据库设计**

- ❌ **MySQL 数据库创建**

  ```sql
  CREATE DATABASE web3_course_platform;
  ```

- ❌ **数据表创建**

  ```sql
  -- 用户表
  CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    wallet_address VARCHAR(42) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    bio TEXT,
    avatar_url TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_wallet (wallet_address)
  );

  -- 课程表
  CREATE TABLE courses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id VARCHAR(50) NOT NULL,
    instructor_address VARCHAR(42) NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    price_yd DECIMAL(18,8) NOT NULL,
    tx_hash VARCHAR(66),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_instructor (instructor_address),
    INDEX idx_course_id (course_id)
  );

  -- 购买记录表
  CREATE TABLE purchases (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_address VARCHAR(42) NOT NULL,
    course_id VARCHAR(50) NOT NULL,
    tx_hash VARCHAR(66) NOT NULL,
    price_paid DECIMAL(18,8),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_course (user_address, course_id)
  );
  ```

##### 🔌 **API 接口开发**

- ❌ **课程相关 API**

  ```javascript
  POST /api/courses              // 创建课程后存储
  GET  /api/courses?page=1&limit=10  // 分页获取课程列表
  POST /api/courses/:courseId/details // 获取课程详情(需签名)
  ```

- ❌ **用户相关 API**

  ```javascript
  POST /api/users/profile        // 更新用户资料(需签名验证)
  GET  /api/users/:address       // 获取用户信息
  ```

- ❌ **购买记录 API**
  ```javascript
  POST / api / purchases; // 记录购买
  ```

##### 🔐 **安全机制**

- ❌ **MetaMask 签名验证**

  ```javascript
  const verifySignature = (message, signature, address) => {
    const recoveredAddress = ethers.verifyMessage(message, signature);
    return recoveredAddress.toLowerCase() === address.toLowerCase();
  };
  ```

- ❌ **防重放攻击**

  ```javascript
  // 时间戳验证（60秒有效期）
  if (Date.now() - timestamp > 60000) {
    return res.status(401).json({ error: "签名已过期" });
  }
  ```

- ❌ **CORS 配置**
- ❌ **错误处理中间件**

#### 🧪 **测试与优化**

##### 功能测试

- ❌ **完整购买流程测试**

  ```
  1. 连接MetaMask钱包 ✓
  2. 切换到Sepolia网络 ✓
  3. 浏览课程列表
  4. 创建新课程
  5. 购买课程 (approve → purchase)
  6. 验证链上购买记录
  7. 验证数据库记录同步
  8. 个人中心显示已购课程
  ```

- ❌ **课程访问权限测试**

  ```
  1. 访问课程详情页
  2. 签名验证身份
  3. 检查购买状态
  4. 显示对应内容
  ```

- ❌ **质押功能完整测试**

  ```
  1. 查看质押页面信息
  2. 输入质押金额
  3. approve → stake
  4. 查看质押信息更新
  5. 等待收益产生
  6. 取消质押获得收益
  ```

- ❌ **用户资料管理测试**
  ```
  1. 修改昵称和简介
  2. MetaMask签名确认
  3. 提交到后端验证
  4. 数据库更新确认
  ```

##### UI/UX 优化

- ❌ **响应式设计** - 移动端适配
- ❌ **加载状态优化** - 各种 loading 状态
- ❌ **错误提示优化** - 用户友好的错误信息
- ❌ **交易状态跟踪** - 实时交易进度显示
- ❌ **Gas 费用估算** - 交易前显示预估费用

#### 🚀 **部署与上线**

- ❌ **前端部署** - Vercel/Netlify
- ❌ **后端部署** - Railway/Heroku
- ❌ **数据库部署** - 云数据库配置
- ❌ **域名配置** - 自定义域名绑定

## 🎯 当前开发阶段与下一步

### 当前状态：前端基础架构已完成 ✅

- 项目搭建 ✅
- 核心 Hook 开发 ✅
- 服务层封装 ✅
- 状态管理 ✅

### 下一步：开发第一个页面组件

**即将开始：WalletButton 组件 + Home 页面**

---

### 📊 进度统计

- **已完成**: 15 个任务 (约 30%)
- **进行中**: 0 个任务
- **待完成**: 35 个任务 (约 70%)

**预估剩余开发时间**: 5-7 天 (前端 3-4 天 + 后端 2-3 天)
